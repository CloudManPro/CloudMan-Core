#.github/workflows/lambda-sync.yml
name: "CloudMan Engine: Lambda Sync"

on:
  # Permitir ser chamado por workflows de outros reposit√≥rios (Clientes/Executores)
  workflow_call:
    inputs:
      # 1. Par√¢metros de Opera√ß√£o
      direction:
        type: string
        description: "push (AWS->Git), pull (Git->AWS) or create"
        required: true
      region:
        type: string
        description: "Default AWS Region"
        default: "us-east-1"
      role_arn:
        type: string
        description: "IAM Role to Assume via OIDC"
        required: true
      resources_json:
        type: string
        description: "JSON Array of resources to sync"
        required: true

      # 2. Par√¢metros do Reposit√≥rio Alvo
      target_repo:
        type: string
        description: "Target Repository (Org/Repo) to sync code with"
        required: true
      target_branch:
        type: string
        description: "Target Branch"
        default: "main"

      # 3. Autentica√ß√£o Automatizada (GitHub App)
      git_token:
        type: string
        description: "App Token passed from backend/listener"
        required: true

  # Permitir disparo manual direto (para testes internos no Core)
  workflow_dispatch:
    inputs:
      direction:
        description: "push, pull or create"
        required: true
      region:
        default: "us-east-1"
      role_arn:
        required: true
      resources_json:
        required: true
      target_repo:
        required: true
      target_branch:
        default: "main"
      git_token:
        required: true

permissions:
  id-token: write   # Obrigat√≥rio para autentica√ß√£o OIDC AWS
  contents: write   # Obrigat√≥rio para Git operations

jobs:
  sync-engine:
    runs-on: ubuntu-latest
    steps:
      - name: üõ°Ô∏è Mask Token
        # Seguran√ßa: Garante que o token n√£o apare√ßa nos logs em texto plano
        run: echo "::add-mask::${{ inputs.git_token }}"

      - name: üì• Checkout Target Repository
        uses: actions/checkout@v4
        with:
          # Baixa o reposit√≥rio definido no input (ex: CloudManPro/CloudMan)
          repository: ${{ inputs.target_repo }}
          ref: ${{ inputs.target_branch }}
          # Usa o token da App para ter permiss√£o de escrita neste reposit√≥rio
          token: ${{ inputs.git_token }}

      - name: üîë Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.role_arn }}
          aws-region: ${{ inputs.region }}
          role-session-name: CloudManSyncSession

      - name: ‚ö° Process Resources (Node.js Script)
        id: processor
        uses: actions/github-script@v7
        env:
          INPUT_DIRECTION: ${{ inputs.direction }}
          INPUT_RESOURCES: ${{ inputs.resources_json }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            // 1. Parse Inputs
            const direction = process.env.INPUT_DIRECTION;
            let resources = [];
            
            try {
                resources = JSON.parse(process.env.INPUT_RESOURCES);
            } catch (e) {
                console.error("‚ùå Failed to parse resources_json. Ensure it's a valid JSON string.");
                throw e;
            }

            console.log(`üöÄ Starting ${direction.toUpperCase()} for ${resources.length} resources...`);

            // Helper: Run Shell Command
            function run(cmd) {
              try {
                // stdio: inherit mostra logs do comando em tempo real no console do Actions
                execSync(cmd, { stdio: 'inherit' }); 
              } catch (e) {
                console.error(`‚ùå Command failed: ${cmd}`);
                throw e;
              }
            }

            // 2. Main Processing Loop
            for (const res of resources) {
                // Support generic 'id' or specific 'function_arn'
                const funcId = res.function_arn || res.id; 
                const folder = res.folder_path || res.git_path;
                const provider = res.provider || 'aws'; // Default AWS
                const region = res.region || '${{ inputs.region }}';

                if (provider !== 'aws') {
                    console.warn(`‚ö†Ô∏è Provider '${provider}' not fully supported yet. Skipping ${funcId}.`);
                    continue;
                }

                console.log(`\n---------------------------------------------------`);
                console.log(`üì¶ Resource: ${funcId}`);
                console.log(`üìÇ Folder: ${folder}`);
                console.log(`üåç Region: ${region}`);

                if (direction === 'push') {
                    // --- PUSH (CLOUD -> GIT) ---
                    console.log('üîΩ Downloading code from AWS...');
                    
                    // a) Get Code URL (AWS CLI)
                    const getUrlCmd = `aws lambda get-function --function-name "${funcId}" --query 'Code.Location' --output text --region ${region}`;
                    const url = execSync(getUrlCmd).toString().trim();

                    if (!url || url === 'None') {
                        throw new Error(`Could not get code URL for ${funcId}. Check if function exists.`);
                    }

                    // b) Download & Unzip safely
                    run(`mkdir -p temp_lambda_dl`);
                    run(`curl -sL "${url}" -o lambda_dl.zip`);
                    run(`unzip -o -q lambda_dl.zip -d temp_lambda_dl`);
                    
                    // c) Sync to Git Folder
                    run(`mkdir -p "${folder}"`);
                    // Rsync: archive mode, verbose, delete extra files locally, exclude .git
                    run(`rsync -av --delete --exclude '.git' temp_lambda_dl/ "${folder}/"`);
                    
                    // d) Cleanup
                    run(`rm -rf temp_lambda_dl lambda_dl.zip`);

                } else if (direction === 'pull') {
                    // --- PULL (GIT -> CLOUD) ---
                    console.log('üîº Uploading code to AWS...');
                    
                    if (!fs.existsSync(folder)) {
                         console.warn(`‚ö†Ô∏è Folder '${folder}' does not exist in repo. Skipping.`);
                         continue;
                    }

                    // a) Zip Folder Content
                    // -X: Keeps file attributes, -r: recursive
                    // Zipa o conte√∫do da pasta, n√£o a pasta em si.
                    const zipName = `deploy_${Date.now()}.zip`;
                    run(`cd "${folder}" && zip -r -X -q "../../${zipName}" .`);

                    // b) Update Function Code
                    run(`aws lambda update-function-code --function-name "${funcId}" --zip-file fileb://${zipName} --region ${region} --publish`);

                    // c) Cleanup
                    run(`rm ${zipName}`);

                } else if (direction === 'create') {
                    // --- CREATE (BOILERPLATE) ---
                    console.log('‚ú® Initializing boilerplate...');
                    
                    if (fs.existsSync(folder)) {
                        console.log(`Folder '${folder}' already exists. Skipping init.`);
                        continue;
                    }
                    
                    run(`mkdir -p "${folder}"`);
                    // Cria um index.js b√°sico (Node.js) como exemplo
                    const boilerplate = `exports.handler = async (event) => {\n  return { statusCode: 200, body: 'Hello from CloudMan!' };\n};`;
                    fs.writeFileSync(path.join(folder, 'index.js'), boilerplate);
                    console.log(`Created index.js in ${folder}`);
                }
            }

      - name: üìù Commit Changes (Push/Create Only)
        if: inputs.direction == 'push' || inputs.direction == 'create'
        run: |
          # Configura o Git com uma identidade gen√©rica de Bot
          git config user.name "CloudMan Bot"
          git config user.email "bot@cloudman.pro"
          
          git add .
          
          # S√≥ faz commit se houver mudan√ßas
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to commit."
          else
            git commit -m "cloudman(sync): Sync code from Cloud [skip ci]"
            # O push usar√° o token configurado no passo de checkout
            git push
            echo "‚úÖ Changes pushed successfully."
          fi
